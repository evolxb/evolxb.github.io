<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS push notification part three · guopp</title><meta name="description" content="iOS push notification part three - guopp"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://guopp.me/atom.xml" title="guopp"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/2008880411/home" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="http://weibo.com/u/2008880411/home" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS push notification part three</h1><div class="post-info">2016年8月26日</div><div class="post-content"><p>苹果的远程推送通知服务(<code>APNs</code>)是远程通知的核心。这是一个强健并且高效的系统来为<code>iOS</code>，<code>watchOS</code>，<code>tvOS</code>设备推送消息。每台设备都和<code>APNs</code>建立了一个加密的可信<code>IP</code>链接，通过这个持久的链接来接收<code>APNs</code>发送给设备的消息。如果通过这个链接发送到设备后，相应的应用不在前台运行，系统会展示相应的警告框提示用户。</p>
<p>你需要使用自己的服务器来为用户生成远程通知。这个服务器被称为<code>Provider</code>，它生成远程通知的数据并且决定什么时候推送这个远程通知。对于每个远程通知，<code>Provider</code>生成通知的<code>payload</code>然后使用<code>HTTP/2</code>的持久的加密链接发送到<code>APNs</code>，<code>APNs</code>负责把通知推送到用户设备。</p>
<a id="more"></a>
<p>苹果的远程推送通知服务(<code>APNs</code>)是远程通知的核心。这是一个强健并且高效的系统来为<code>iOS</code>，<code>watchOS</code>，<code>tvOS</code>设备推送消息。每台设备都和<code>APNs</code>建立了一个加密的可信<code>IP</code>链接，通过这个持久的链接来接收<code>APNs</code>发送给设备的消息。如果通过这个链接发送到设备后，相应的应用不在前台运行，系统会展示相应的警告框提示用户。</p>
<p>你需要使用自己的服务器来为用户生成远程通知。这个服务器被称为<code>Provider</code>，它生成远程通知的数据并且决定什么时候推送这个远程通知。对于每个远程通知，<code>Provider</code>生成通知的<code>payload</code>然后使用<code>HTTP/2</code>的持久的加密链接发送到<code>APNs</code>，<code>APNs</code>负责把通知推送到用户设备。</p>
<h1 id="远程通知的路径"><a href="#远程通知的路径" class="headerlink" title="远程通知的路径"></a>远程通知的路径</h1><p><code>APNs</code>负责分发你的<code>Provider</code>传过来的通知到你的应用的用户的设备。当你的<code>Provider</code>需要推送一个通知，它把这个通知和设备的<code>token</code>一起发送到<code>APNs</code>。<code>APNs</code>会把这个通知传递到用户设备，设备上的操作系统会负责传递这个通知到相应的应用程序。如下图：<br><img src="http://7xvudw.com1.z0.glb.clouddn.com/Screen%20Shot%202016-08-26%20at%2016.53.28.png" alt=""></p>
<p>你传给服务器的设备<code>token</code>和手机号是类似的。它包含设备的信息，<code>APNs</code>使用这个<code>token</code>能定位你的应用程序安装的设备。<code>APNs</code>也会用它来验证通知发送的过程中的路由信息。通过注册远程通知服务，系统会发送设备的<code>token</code>给你的应用程序。</p>
<p>通知的<code>payload</code>是你想发送给设备的数据，它是一个<code>JSON</code>字典。<code>payload</code>包含系统提示用户的方式，如警告框，<code>badge</code>,声音。它也能包括你自定义的数据。</p>
<p>下图展示了<code>APNs</code>在设备和<code>Provider</code>之间的虚拟网络。在<code>APNs</code>的两边－－设备方和<code>APNs</code>和<code>Provider</code>方和<code>APNs</code>之间－－都会有多个连接。在<code>Provider</code>和<code>APNs</code>的这边，它们被称为网关。通常都会有多个<code>Provider</code>,每个<code>Provier</code>都通过网关和<code>APNs</code>建立一个或多个持久的加密连接。这些<code>Provider</code>通过<code>APNs</code>发送通知到它们的客户端设备上。<br><img src="http://7xvudw.com1.z0.glb.clouddn.com/Screen%20Shot%202016-08-26%20at%2017.47.07.png" alt=""></p>
<h1 id="推送服务质量"><a href="#推送服务质量" class="headerlink" title="推送服务质量"></a>推送服务质量</h1><p><code>APNs</code>默认包含一个存储和转发功能的组件。如果要推送的设备不在线，要推送的通知会被<code>APNs</code>暂存一段时间，当设备上线之后会推送到设备。但是只有一个通知会被暂存。当有多个通知推送到设备而设备此时不在线时，最新的一个通知会被暂存，而以前的通知会被丢弃。这被称为通知合并。</p>
<p>如果设备长时间离线，那么所有的通知都会被丢弃。</p>
<h2 id="安全架构"><a href="#安全架构" class="headerlink" title="安全架构"></a>安全架构</h2><p>为了保证安全的通信，<code>APNs</code>使用两种不同的信任级别在<code>Porvider</code>和设备之间：<code>connection trust</code>和<code>token trust</code>。</p>
<p><code>Connection trust</code>保障<code>APNs</code>是连接到一个被授权可以推送通知的<code>Provider</code>上。<code>APNs</code>也会使用<code>connection trust</code>来连接到设备以保证设备的合法性。<code>APNs</code>到设备的可信连接是<code>APNs</code>自动处理的，但是<code>Provider</code>到<code>APNs</code>之间的可信连接必须要你自己负责。</p>
<p><code>Token trust</code>确保通知是在合法的起始点和终止点之间传送。<code>Token trust</code>涉及到设备<code>token</code>的使用，这是分配给特定设备上的特定应用的标识符。每个应用通过注册远程通知服务来获取它的唯一设备标识符，而且必须要把这个标识符传到服务器。因此，这个标识符应该和通知一同被<code>Provider</code>发送到<code>APNs</code>。提供这个标识符用于传递通知到特定的设备上的特定应用程序。</p>
<blockquote>
<p>注意：设备标识符并不能用来区分设备的唯一性。</p>
</blockquote>
<p><code>APNs</code>也会使用必要的证书，CA证书和密钥（公钥和私钥）来验证<code>Provider</code>和设备之间的连接。</p>
<h2 id="Provider到APNs之间的可信连接"><a href="#Provider到APNs之间的可信连接" class="headerlink" title="Provider到APNs之间的可信连接"></a><code>Provider</code>到<code>APNs</code>之间的可信连接</h2><p>每个<code>Provider</code>都必须要有一个唯一的证书和私钥，<code>APNs</code>会使用它们来验证它和<code>Provider</code>之间的连接。<code>Provider</code>的证书标示它所支持的应用的<code>bundle id</code>。</p>
<p>你的<code>Provider</code>通过<code>TLS</code>的对等网络建立可信连接到<code>APNs</code>。当<code>TLS</code>连接初始化后，你会得到<code>APNs</code>的服务端证书，然后在你这边验证证书。然后你发送你的<code>Provider</code>证书给<code>APNs</code>，<code>APNs</code>也会在它那边验证你的证书。当这个过程完成后，一个安全和可信的<code>TLS</code>就被合法的<code>Provider</code>建立了。<br><img src="http://7xvudw.com1.z0.glb.clouddn.com/Screen%20Shot%202016-08-26%20at%2019.52.08.png" alt=""></p>
<h2 id="APNs到设备的可信连接"><a href="#APNs到设备的可信连接" class="headerlink" title="APNs到设备的可信连接"></a><code>APNs</code>到设备的可信连接</h2><p>每个设备都有一个设备证书和私钥。它们用来验证和<code>APNs</code>之间的连接。设备在激活的时候会获取这个证书和私钥然后把它们保存在钥匙串中。</p>
<p>你不需要做任何事来建立<code>APNs</code>和设备之间的可信连接。<code>APNs</code>会通过<code>TLS</code>来建立到设备的可信连接。在这种情况下，设备初始化<code>TLS</code>连接，<code>APNs</code>返回服务器证书.设备验证这个证书然后发送自己的设备证书给<code>APNs</code>,<code>APNs</code>验证这个证书。<br><img src="http://7xvudw.com1.z0.glb.clouddn.com/Screen%20Shot%202016-08-26%20at%2020.01.19.png" alt=""></p>
<h2 id="Token的生成和发送"><a href="#Token的生成和发送" class="headerlink" title="Token的生成和发送"></a><code>Token</code>的生成和发送</h2><p>设备想要收到远程通知必须先在系统中注册远程通知服务。当系统收到应用的注册请求时会把这个请求转发到<code>APNs</code>。<code>APNs</code>会使用设备的证书中的信息为应用生成一个唯一的设备<code>token</code>，然后加密这个<code>token</code>再把它返回给设备。系统通过<code>NSData</code>把设备<code>token</code>传递给应用。当收到这个设备<code>token</code>后，应用应该使用二进制或者十六进制把这个<code>token</code>发送给你的服务器。服务器不能把通知推送到没用这个<code>token</code>的设备。流程如下图：<br><img src="http://7xvudw.com1.z0.glb.clouddn.com/Screen%20Shot%202016-08-27%20at%2016.00.07.png" alt=""></p>
<blockquote>
<p><code>APNs</code>的设备<code>token</code>长度是可变的。不要写死长度。</p>
</blockquote>
<p>下图显示设备<code>token</code>的生成和转发路径，还有上传到<code>Provider</code>的部分。<br><img src="http://7xvudw.com1.z0.glb.clouddn.com/Screen%20Shot%202016-08-27%20at%2016.04.15.png" alt=""></p>
<h2 id="Token-Trust-Notification"><a href="#Token-Trust-Notification" class="headerlink" title="Token Trust (Notification)"></a>Token Trust (Notification)</h2><p>每个从<code>Provider</code>发送给<code>APNs</code>的远程通知都必须和<code>device token</code>一起发送。<code>APNs</code>使用它的<code>token key</code>解密通知中的<code>token</code>来确保<code>Provider</code>的合法性。然后使用<code>device token</code>中的<code>device ID</code>来决定推送的目标设备，最后把这个通知推送给目标设备。<br><img src="http://7xvudw.com1.z0.glb.clouddn.com/Screen%20Shot%202016-08-27%20at%2016.08.56.png" alt=""></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/08/27/iOS-push-notification-part-one/" class="prev">上一篇</a></div><div data-thread-key="2016/08/26/iOS-push-notification-part-three/" data-title="iOS push notification part three" data-url="http://guopp.me/2016/08/26/iOS-push-notification-part-three/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"guopp"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2016 <a href="http://guopp.me">guopp</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>